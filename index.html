<!doctype html>
<html lang="en">

<head>
    <title>Text Block Planner</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="scripts/navScript.js" defer></script>


    <script type="module">
        import { getFontList } from './scripts/pickFont.js';

        window.addEventListener("DOMContentLoaded", () => {

            //Paper Information Tab
            let pageWidth = 528;
            let pageHeight = 816;
            let paperGSM = 75;
            //Text Area Information
            let textAreaWidth = pageWidth;
            let textAreaHeight = pageHeight;

            //Text Information Tab
            let fileName = "Your File";
            //usable text string
            let targetText = "";
            //let numCharacters = 0;
            let numSections = 1;

            //Text Formating Tab
            let topBottomMargin = 0;
            let insideMargin = 0;
            let outsideMargin = 0;
            let targetFontPt = 12;
            let fontFamily = "Times New Roman";
            //let paragraphInd = .3;
            let lineSpacing = 1.5;
            let paragraphSpacing = 1;


            /*
            * take in page width from user in px. 
            */
            const pageWidthIn = document.getElementById("widthInput");
            document.querySelector('#widthInput').addEventListener("change", event => {
                pageWidth = pageWidthIn.value;
                //calcTextAraeaWidth();
                textMeasure();
            })


            /*
            * take in page height from user in px. 
            */
            const pageHeightIn = document.getElementById("heightInput");
            document.querySelector('#heightInput').addEventListener("change", event => {
                pageHeight = pageHeightIn.value;
                //calcTextAraeaWidth();
                textMeasure();
            })

            /*
            * take in paper weight from user in GSM. 
            */
            const paperGSMinput = document.getElementById("paperWeight");
            document.querySelector('#paperWeight').addEventListener("change", event => {
                paperGSM = paperGSMinput.value;
                textMeasure();
            })


            /*
            * take in text file from user. 
            */
            const filePicker = document.getElementById('filePicker');
            filePicker.addEventListener('change', handleFiles, false);

            function handleFiles() {
                const fileList = this.files;
                console.log(fileList);


                for (const file of fileList) {

                    const fileReader = new FileReader();
                    fileReader.readAsText(file);

                    fileReader.onload = function () {

                        let thisText = fileReader.result;

                        //TEST
                        console.log("readTXTfile __")
                        console.log(thisText);

                        targetText = targetText + thisText;

                        //TEST
                        console.log("RTF Target __");
                        console.log(targetText);

                        return thisText;
                        //
                    };
                    fileReader.onerror = function () {

                        //TEST
                        console.log(fileReader.error);
                    };

                    textMeasure();
                }

                //textMeasure();
            }


            /*
            * get section count from user
            */
            const sectionCountIn = document.getElementById("numSections");
            document.querySelector('#numSections').addEventListener("change", event => {
                numSections = sectionCountIn.value;
                textMeasure();
            })


            /*
            * Margin Input from user
            */

            /*
            * get top and bottom margin size from user in px.
            */
            const topBottomMarginIn = document.getElementById("topBotomInput");
            document.querySelector('#topBotomInput').addEventListener("change", event => {
                topBottomMargin = topBottomMarginIn.value;
                textAreaHeight = pageHeight - (topBottomMargin * 2);
                textMeasure();
            })

            /*
            * get inside margin size from user in px.
            */
            const insideMarginIn = document.getElementById("insideInput");
            document.querySelector('#insideInput').addEventListener("change", event => {
                insideMargin = insideMarginIn.value;
                textMeasure();
            })

            /*
            * get outside margin size from user in px.
            */
            const ousideMarginIn = document.getElementById("outsideInput");
            document.querySelector('#outsideInput').addEventListener("change", event => {
                outsideMargin = ousideMarginIn.value;
                textMeasure();
            })

            /*
            * calculate and set the Text Area Width
            */
            let calcTextAraeaWidth = function () {

                //test
                console.log("IM__"+insideMargin+"__OM__"+outsideMargin);
                textAreaWidth = pageWidth - (insideMargin + outsideMargin);
            }

            /*
            * Font input from user 
            */

            /*
            * get font size  from user in points
            */
            const fontSizeIn = document.getElementById("pointSizeFont");
            document.querySelector('#pointSizeFont').addEventListener("change", event => {
                targetFontPt = fontSizeIn.value;
                textMeasure();
            })

            /*
            * get font family from user 
            */
            const fontPicker = document.getElementById("fontList");
            document.querySelector('#fontList').addEventListener("change", event => {
                fontFamily = fontPicker.value;
                textMeasure();
            })


            /*
            * get font list and populate fontList selector 
            */
            getFontList().then(results => {
                let html = `<option value='-1'>Select your font</option>`;
                if (results) {
                    results.forEach(font => {
                        html += `<option value='${font.family}'>${font.family}</option>`;
                    });
                    document.querySelector("#fontList").innerHTML = html;
                }
            })


            /*
            * REMOVED!! the css that I wanted to use was experimental and does not work
            * get paragraph indent from user
            */
            /*             const paragraphIndentIn = document.getElementById("pointSizeIndent");
                        document.querySelector('#pointSizeIndent').addEventListener("change", event => {
                            paragraphInd = paragraphIndentIn.value;
                        }) */


            /*
            * get line spacing  from user
            */
            const lineSpaceIn = document.getElementById("lineSpacing");
            document.querySelector('#lineSpacing').addEventListener("change", event => {
                lineSpacing = lineSpaceIn.value;
                textMeasure();
            })


            /*
            * get paragraph spacing  from user
            */
            const paragraphSpaceIn = document.getElementById("paragraphSpacing");
            document.querySelector('#paragraphSpacing').addEventListener("change", event => {
                paragraphSpacing = paragraphSpaceIn.value;
                textMeasure();
            })



            /*
            * TEST FOR CANVAS and TEXT METRICS
            * Need to find a way to do this that restrict the placement of text and wrapps text for measuring
            */
            const textMeasure1 = function () {
                const canvas = document.getElementById("canvasNoShow");
                const ctx = canvas.getContext("2d");
                //ctx.font = document.querySelector("#fontList").value;
                let fontPick = document.getElementById("fontList");
                let valueFont = fontPick.value;
                //TEST
                console.log("fontVal _" + valueFont);

                let textFont = fontPick.options[fontPick.selectedIndex].text;
                //TEST
                console.log("fontTxt _" + textFont);

                ctx.font = textFont;

                const textMetrics = ctx.measureText(targetText);

                console.log("text Width __" + textMetrics.width);
                let textWidth = textMetrics.actualBoundingBoxRight + textMetrics.actualBoundingBoxLeft;
                console.log("text Width2 __" + textWidth);
                let textHeight = textMetrics.actualBoundingBoxAscent + textMetrics.actualBoundingBoxDescent;
                console.log("text Height __" + textHeight);
            }


            /*
            * Get measure of height added to text by paragraph spacing
            */
            const getParaSpace = function (linesBetween) {
                let newLineCount = (targetText.match(/\n/g) || []).length;
                //TEST
                console.log("numParagraphs __" + newLineCount);
                let addUnit = targetFontPt * lineSpacing;
                let totalAdded = (linesBetween * addUnit) * newLineCount;

                //TEST
                console.log("added for paragraphs __" + totalAdded);
                return totalAdded;
            }

            /*
            * TEST FOR DIV MEASUREMENT
            * Need to ask prof about better way to do this, this one blinks
            */
            const numPageRes = document.getElementById("resultNumPages");
            const numSheetsRes = document.getElementById("resultNumSheets");
            const thicknessBlockRes = document.getElementById("resultBlockThickness");
            const textMeasure = function () {
                let noShowDiv = document.getElementById("textNoShow");
                noShowDiv.innerText = targetText;

                noShowDiv.style.fontSize = targetFontPt + "pt";
                noShowDiv.style.fontFamily = fontFamily;
                noShowDiv.style.lineHeight = lineSpacing;
                calcTextAraeaWidth();
                noShowDiv.style.width = textAreaWidth + "px";


                noShowDiv.style.display = "block";
                let divHeight = noShowDiv.clientHeight;

                //add in paragrph spacing
                divHeight = divHeight + getParaSpace(paragraphSpacing);

                let divWidth = noShowDiv.clientWidth + "px";
                noShowDiv.style.display = "none";
                let pages = Math.ceil(divHeight / textAreaHeight);
                let sheets = Math.ceil(pages / 4);
                let thick = blockThicknessMM(paperGSM, pages);
                numPageRes.innerText = pages;
                numSheetsRes.innerText = sheets;
                thicknessBlockRes.innerText = thick;
                console.log("Height_" + divHeight + "__Width_" + divWidth + "_");
                console.log(noShowDiv.innerText);
            }


            /*
            * TEST FOR TESXT THICKNESS MEASUREMENT
            * translates paper GSM and page count to aproxomate thickness of textblock in MM
            */
            const blockThicknessMM = function (pageThicknessGSM, pageCount) {
                let factorGSMtoMM = 0.001328146;
                let mmMeasure = pageThicknessGSM * factorGSMtoMM;
                let thickness = (pageCount / 2) * mmMeasure;
                return thickness;
            }

        });


    </script>
</head>



<body>

    <div class="flex-container" style="background-color:greenyellow;">
        <div class="pageHeader" id="pageHeader" style="background-color: lightcoral;">
            <H4>**under construction**</H4>
            <h1>How Big Is My TextBlock?</h1>
        </div>

        <div style="float: right; display: none;">
            <canvas id="canvasNoShow" width="500px"></canvas>
        </div>



        <div id="pageContent">
            <div class="tabBar" style="background-color: coral;">

                <div>
                    <h3 data-tab-target="#settings">Settings</h3>

                    <div class="tab" id="settings" data-tab-content style="background-color: plum;">
                        <div>
                            <h5>Units</h5>
                            <fieldset>

                                <legend>Select a Linear Measurement Unit:</legend>

                                <div>
                                    <input type="radio" id="pageInCM" name="pageLinearUnit" value="cm">
                                    <label for="pageInCM">cm</label>
                                </div>
                                <div>
                                    <input type="radio" id="pageInIN" name="pageLinearUnit" value="in">
                                    <label for="pageInIN">in</label>
                                </div>
                                <div>
                                    <input type="radio" id="pageInPX" name="pageLinearUnit" value="pixels">
                                    <label for="pageInPX">pixels</label>
                                </div>

                            </fieldset>

                            <fieldset>

                                <legend>Select a Weight Measurement Unit:</legend>

                                <div>
                                    <input type="radio" id="blockInKG" name="pageWeightUnit" value="kg">
                                    <label for="blockInKG">cm</label>
                                </div>
                                <div>
                                    <input type="radio" id="blockInLB" name="pageWeightUnit" value="lb">
                                    <label for="blockInLB">in</label>
                                </div>

                            </fieldset>
                        </div>

                    </div>
                </div>

                <div>
                    <h3 data-tab-target="#paper">Paper Information</h3>

                    <div class="tabContent">
                        <div class="tab" id="paper" data-tab-content style="background-color: aqua;">
                            <div>
                                <h5>Page Dimentions</h5>

                                <div>
                                    <label for="widthInput">Page Width</label>
                                    <input type="number" id="widthInput" name="widthInput" required minlength="1"
                                        size="10">
                                </div>

                                <div>
                                    <label for="heightInput">Page Height</label>
                                    <input type="number" id="heightInput" name="heightInput" required minlength="1"
                                        size="10">
                                </div>

                            </div>

                            <div>
                                <h5>Paper Weight</h5>
                                <div>
                                    <input type="number" id="paperWeight" name="paperWeight">
                                    <label for="paperWeight">gsm</label>
                                </div>
                            </div>

                            <h4>Advanced</h4>
                            <p>Paper Thickness</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 data-tab-target="#text">Text Information</h3>

                    <div class="tabContent">
                        <div class="tab" id="text" data-tab-content style="background-color:aquamarine;">
                            <div>
                                <h5>Input TXT File</h5>
                                <input type="file" id="filePicker" multiple accept=".txt">

                            </div>

                            <!--
                            <div>
                                <h5>Number of characters &#40;Include spaces and punctuation&#41;</h5>
                                <div>
                                    <input type="number" id="numCharacters" name="numCharacters" minlength="1">
                                    <label for="numCharacters">Character Count</label>
                                </div>
                            </div>
                            -->

                            <div>
                                <h5>Number of chapters or sections</h5>
                                <div>
                                    <input type="number" id="numSections" name="numSections">
                                    <label for="numSections">Chapter/Section Count</label>
                                </div>
                            </div>

                            <h4>Advanced</h4>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 data-tab-target="#formatting">Text Formatting</h3>

                    <div class="tabContent">
                        <div class="tab" id="formatting" data-tab-content style="background-color:bisque;">
                            <div>
                                <div>
                                    <h4>Page Margins</h4>
                                    <div>
                                        <label for="topBotomInput">Top and Bottom Margins</label>
                                        <input type="number" id="topBotomInput" name="topBotomInput" required
                                            minlength="1" size="10">
                                    </div>

                                    <div>
                                        <label for="insideInput">Inside Margins</label>
                                        <input type="number" id="insideInput" name="insideInput" required minlength="1"
                                            size="10">
                                    </div>

                                    <div>
                                        <label for="outsideInput">Outside Margins</label>
                                        <input type="number" id="outsideInput" name="outsideInput" required
                                            minlength="1" size="10">
                                    </div>
                                </div>
                                <div>
                                    <h4>Font Formating</h4>
                                    <div>
                                        <h5>Font point size of body text</h5>
                                        <label for="pointSizeFont">Pt: </label>
                                        <input type="number" id="pointSizeFont" name="pointSizeFont" required
                                            minlength="1" size="5">
                                    </div>

                                    <div>
                                        <h5>Font</h5>
                                        <label for="fontList">Select: </label>
                                        <select id="fontList"></select>
                                    </div>
                                </div>



                                <div>
                                    <h4>Paragraph formating</h4>
                                    <!--
                                    <div>
                                        <h5>Paragraph Indent</h5>
                                        <label for="pointSizeIndent">Pt: </label>
                                        <input type="number" id="pointSizeIndent" name="pointSizeIndent" required
                                            minlength="1" size="5">
                                    </div>
-->
                                    <div>
                                        <h5>Line Spacing</h5>
                                        <label for="lineSpacing">Spacing: </label>
                                        <input type="number" id="lineSpacing" name="lineSpacing" required minlength="1"
                                            size="5">
                                    </div>

                                    <div>
                                        <h5>Line Spacing Between Paragraphs</h5>
                                        <label for="paragraphSpacing">Spacing: </label>
                                        <input type="number" id="paragraphSpacing" name="paragraphSpacing" required
                                            minlength="1">
                                    </div>
                                </div>
                                <div>
                                    <h4>Advanced</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 data-tab-target="#extras">Extras</h3>

                        <div class="tabContent">
                            <div class="tab" id="extras" data-tab-content style="background-color:violet;">

                                <div>
                                    <h5>Fly Leaves</h5>
                                    <label for="numFlyLeaves">Number of fly leaves, front and back: </label>
                                    <input type="number" id="numFlyLeaves" name="numFlyLeaves" size="5">
                                </div>

                                <div>
                                    <h5>Title Page</h5>
                                    <label for="titlePageAdd">Add </label>
                                    <input type="checkbox" id="titlePageAdd" name="titlePageAdd">
                                </div>

                                <div>
                                    <h5>Table of Contents</h5>
                                    <label for="tocPageAdd">Add </label>
                                    <input type="checkbox" id="tocPageAdd" name="tocPageAdd">
                                </div>

                                <div>
                                    <h5>Book Information or Copyright</h5>
                                    <label for="bookInfoPageAdd">Add </label>
                                    <input type="checkbox" id="bookInfoPageAdd" name="bookInfoPageAdd">
                                </div>

                                <div>
                                    <h5>Chapter heading</h5>
                                    <label for="chHeadPage">Portion of Page Taken: </label>
                                    <input type="number" id="chHeadPage" name="chHeadPage" size="5">
                                </div>

                                <div>
                                    <h5>Images</h5>
                                    <label for="imagePage">Pages taken up by images: </label>
                                    <input type="number" id="imagePage" name="imagePage" size="5">
                                </div>

                                <div>
                                    <h4>Advanced</h4>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 data-tab-target="#results">Textblock Results</h3>

                        <div class="tabContent">
                            <div class="tab active" id="results" data-tab-content
                                style="background-color:cornflowerblue;">

                                <div>
                                    <h4>Approximates</h4>
                                </div>

                                <div>
                                    <h5>Number of pages: </h5>
                                    <div id="resultNumPages" style="background-color: deeppink;">?</div>
                                </div>

                                <div>
                                    <h5>Number of sheets</h5>
                                    <div id="resultNumSheets" style="background-color: deeppink;">?</div>
                                </div>

                                <div>
                                    <h5>Textblock thickness</h5>
                                    <div id="resultBlockThickness" style="background-color: deeppink;">?</div>
                                </div>

                                <div>
                                    <h5>Textblock weight</h5>
                                    <div id="resultWeight" style="background-color: deeppink;">?</div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>

        <div id="textNoShow" style="display: none;">!</div>
    </div>
</body>

</html>